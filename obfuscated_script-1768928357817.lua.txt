--[[
    Arqel Key System API v1.0
    
    Methods:
    - :LaunchJunkie(config) - For Junkie Development
    - :Launch() - For Custom/Other Services
    - :Notify(title, msg, duration, type) - Show notification
    - :GetSavedKey() - Get stored key
    - :ClearSavedKey() - Delete stored key
]]

local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local HttpService = game:GetService("HttpService")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")

local Arqel = {}

Arqel.Appearance = {
    Title = "Arqel",
    Subtitle = "Enter your key to continue",
    Icon = "rbxassetid://95721401302279",
    IconSize = UDim2.new(0, 30, 0, 30)
}

Arqel.Links = {
    GetKey = "",
    Discord = ""
}

Arqel.Storage = {
    FileName = "Arqel_Key",
    Remember = true,
    AutoLoad = true
}

Arqel.Options = {
    Keyless = nil,
    Blur = true,
    Draggable = true
}

Arqel.Theme = {
    Accent = Color3.fromRGB(139, 0, 0),
    AccentHover = Color3.fromRGB(170, 20, 20),
    Background = Color3.fromRGB(15, 15, 15),
    Header = Color3.fromRGB(20, 20, 20),
    Input = Color3.fromRGB(25, 25, 25),
    Text = Color3.fromRGB(255, 255, 255),
    TextDim = Color3.fromRGB(120, 120, 120),
    Success = Color3.fromRGB(50, 205, 110),
    Error = Color3.fromRGB(245, 70, 90),
    Warning = Color3.fromRGB(255, 180, 50),
    StatusIdle = Color3.fromRGB(180, 80, 80),
    Discord = Color3.fromRGB(88, 101, 242),
    DiscordHover = Color3.fromRGB(114, 137, 218),
    Divider = Color3.fromRGB(45, 45, 70)
}

Arqel.Callbacks = {
    OnVerify = nil,
    OnSuccess = nil,
    OnFail = nil,
    OnClose = nil
}

local Internal = {
    Junkie = nil,
    BlurEffect = nil,
    NotificationList = {},
    ValidateFunction = nil,
    IsJunkieMode = false
}

local Icons = {
    key = "rbxassetid://96510194465420",
    shield = "rbxassetid://89965059528921",
    check = "rbxassetid://76078495178149",
    copy = "rbxassetid://125851897718493",
    discord = "rbxassetid://83278450537116",
    alert = "rbxassetid://140438367956051",
    lock = "rbxassetid://114355063515473",
    loading = "rbxassetid://116535712789945",
    close = "rbxassetid://6022668916"
}

local function isMobile()
    return UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled
end

local function getScale()
    local viewport = Workspace.CurrentCamera.ViewportSize
    return math.clamp(math.min(viewport.X, viewport.Y) / 900, 0.65, 1.3)
end

local function hasFileSystem()
    local ok1 = pcall(function() return type(writefile) == "function" end)
    local ok2 = pcall(function() return type(readfile) == "function" end)
    local ok3 = pcall(function() return type(isfile) == "function" end)
    return ok1 and ok2 and ok3
end

local fileSystemSupported = hasFileSystem()

local function getFileName()
    return Arqel.Storage.FileName .. ".txt"
end

local function saveKey(key)
    if not fileSystemSupported or not Arqel.Storage.Remember then return false end
    return pcall(function() writefile(getFileName(), key) end)
end

local function loadKey()
    if not fileSystemSupported then return nil end
    local ok, content = pcall(function()
        if isfile(getFileName()) then return readfile(getFileName()) end
        return nil
    end)
    if ok and content and content ~= "" then return content end
    return nil
end

local function clearKey()
    if not fileSystemSupported then return false end
    return pcall(function() delfile(getFileName()) end)
end

local function enableBlur()
    if not Arqel.Options.Blur then return end
    local existing = Lighting:FindFirstChild("ArqelKeySystemBlur")
    if existing then existing:Destroy() end
    Internal.BlurEffect = Instance.new("BlurEffect")
    Internal.BlurEffect.Name = "ArqelKeySystemBlur"
    Internal.BlurEffect.Size = 0
    Internal.BlurEffect.Parent = Lighting
    TweenService:Create(Internal.BlurEffect, TweenInfo.new(0.4, Enum.EasingStyle.Quart), {Size = 24}):Play()
end

local function disableBlur()
    if Internal.BlurEffect and Internal.BlurEffect.Parent then
        TweenService:Create(Internal.BlurEffect, TweenInfo.new(0.3, Enum.EasingStyle.Quart), {Size = 0}):Play()
        task.delay(0.3, function()
            if Internal.BlurEffect and Internal.BlurEffect.Parent then
                Internal.BlurEffect:Destroy()
                Internal.BlurEffect = nil
            end
        end)
    else
        local existing = Lighting:FindFirstChild("ArqelKeySystemBlur")
        if existing then existing:Destroy() end
        Internal.BlurEffect = nil
    end
end

local function setupDragging(header, main)
    if not Arqel.Options.Draggable then return end
    local dragging, dragStart, startPos
    
    header.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = main.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - dragStart
            main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
end

function Arqel:Notify(title, message, duration, iconType)
    duration = duration or 5
    iconType = iconType or "info"
    
    local scale = getScale()
    local width = math.clamp(320 * scale, 260, 380)
    local height = math.clamp(80 * scale, 65, 95)
    
    local notifGui = Instance.new("ScreenGui")
    notifGui.ResetOnSpawn = false
    notifGui.DisplayOrder = 999999
    notifGui.Parent = CoreGui
    
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, width, 0, height)
    frame.Position = UDim2.new(1, width + 20, 1, -15)
    frame.AnchorPoint = Vector2.new(1, 1)
    frame.BackgroundColor3 = Arqel.Theme.Header
    frame.BorderSizePixel = 0
    frame.Parent = notifGui
    
    Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 4)
    
    local stroke = Instance.new("UIStroke", frame)
    stroke.Color = Arqel.Theme.Accent
    stroke.Thickness = 1
    stroke.Transparency = 0.7
    
    local progressBg = Instance.new("Frame")
    progressBg.Size = UDim2.new(1, 0, 0, 4)
    progressBg.Position = UDim2.new(0, 0, 1, -4)
    progressBg.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    progressBg.BorderSizePixel = 0
    progressBg.Parent = frame
    
    local progressBar = Instance.new("Frame")
    progressBar.Size = UDim2.new(1, 0, 1, 0)
    progressBar.BackgroundColor3 = Arqel.Theme.Accent
    progressBar.BorderSizePixel = 0
    progressBar.Parent = progressBg
    
    local iconSize = height - 35
    local icon = Instance.new("ImageLabel")
    icon.Size = UDim2.new(0, iconSize, 0, iconSize)
    icon.Position = UDim2.new(0, 14, 0.5, -2)
    icon.AnchorPoint = Vector2.new(0, 0.5)
    icon.BackgroundTransparency = 1
    icon.ScaleType = Enum.ScaleType.Fit
    icon.Parent = frame
    
    local iconMap = {
        success = {Icons.check, Arqel.Theme.Success},
        error = {Icons.alert, Arqel.Theme.Error},
        warning = {Icons.alert, Arqel.Theme.Warning},
        shield = {Icons.shield, Arqel.Theme.Accent},
        info = {Icons.shield, Arqel.Theme.Accent},
        key = {Icons.key, Arqel.Theme.Accent},
        copy = {Icons.copy, Arqel.Theme.Success},
        discord = {Icons.discord, Arqel.Theme.Discord},
        close = {Icons.close, Arqel.Theme.Error}
    }
    
    if iconMap[iconType] then
        icon.Image = iconMap[iconType][1]
        icon.ImageColor3 = iconMap[iconType][2]
    else
        icon.Image = Arqel.Appearance.Icon
        icon.ImageColor3 = Arqel.Theme.Text
    end
    
    local textX = 14 + iconSize + 14
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, -(textX + 14), 0, 24)
    titleLabel.Position = UDim2.new(0, textX, 0, 12)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextSize = math.clamp(15 * scale, 13, 18)
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.TextColor3 = Arqel.Theme.Text
    titleLabel.Text = title
    titleLabel.TextTruncate = Enum.TextTruncate.AtEnd
    titleLabel.Parent = frame
    
    local messageLabel = Instance.new("TextLabel")
    messageLabel.Size = UDim2.new(1, -(textX + 14), 0, 22)
    messageLabel.Position = UDim2.new(0, textX, 0, 38)
    messageLabel.BackgroundTransparency = 1
    messageLabel.Font = Enum.Font.GothamMedium
    messageLabel.TextSize = math.clamp(13 * scale, 11, 15)
    messageLabel.TextXAlignment = Enum.TextXAlignment.Left
    messageLabel.TextColor3 = Arqel.Theme.TextDim
    messageLabel.Text = message
    messageLabel.TextTruncate = Enum.TextTruncate.AtEnd
    messageLabel.Parent = frame
    
    local id = tick() .. HttpService:GenerateGUID(false)
    table.insert(Internal.NotificationList, {id = id, frame = frame, gui = notifGui, height = height})
    
    local function restack()
        local yOffset = 0
        for i = #Internal.NotificationList, 1, -1 do
            local n = Internal.NotificationList[i]
            if n and n.frame and n.frame.Parent then
                TweenService:Create(n.frame, TweenInfo.new(0.3, Enum.EasingStyle.Quart), {
                    Position = UDim2.new(1, -15, 1, -15 - yOffset)
                }):Play()
                yOffset = yOffset + n.height + 12
            end
        end
    end
    
    TweenService:Create(frame, TweenInfo.new(0.4, Enum.EasingStyle.Quart), {
        Position = UDim2.new(1, -15, 1, -15)
    }):Play()
    
    task.wait(0.1)
    restack()
    
    local function dismiss()
        for i, n in ipairs(Internal.NotificationList) do
            if n.id == id then
                table.remove(Internal.NotificationList, i)
                break
            end
        end
        TweenService:Create(frame, TweenInfo.new(0.3, Enum.EasingStyle.Quart), {
            Position = UDim2.new(1, width + 20, frame.Position.Y.Scale, frame.Position.Y.Offset)
        }):Play()
        task.wait(0.3)
        notifGui:Destroy()
        restack()
    end
    
    TweenService:Create(progressBar, TweenInfo.new(duration, Enum.EasingStyle.Linear), {
        Size = UDim2.new(0, 0, 1, 0)
    }):Play()
    task.delay(duration, dismiss)
    
    local clickBtn = Instance.new("TextButton")
    clickBtn.Size = UDim2.new(1, 0, 1, 0)
    clickBtn.BackgroundTransparency = 1
    clickBtn.Text = ""
    clickBtn.Parent = frame
    clickBtn.MouseButton1Click:Connect(dismiss)
end

local function BuildKeylessUI()
    local oldGui = CoreGui:FindFirstChild("ArqelKeylessSystem")
    if oldGui then oldGui:Destroy() end
    
    enableBlur()
    
    local mobile = isMobile()
    local padding = 14
    
    local gui = Instance.new("ScreenGui")
    gui.Name = "ArqelKeylessSystem"
    gui.ResetOnSpawn = false
    gui.IgnoreGuiInset = true
    gui.Parent = CoreGui
    
    local main = Instance.new("Frame")
    main.Size = UDim2.new(0, 300, 0, 265)
    main.Position = UDim2.new(0.5, 0, 1.5, 0)
    main.AnchorPoint = Vector2.new(0.5, 0.5)
    main.BackgroundColor3 = Arqel.Theme.Background
    main.BorderSizePixel = 0
    main.Parent = gui
    
    Instance.new("UICorner", main).CornerRadius = UDim.new(0, 4)
    
    local mainStroke = Instance.new("UIStroke", main)
    mainStroke.Color = Arqel.Theme.Accent
    mainStroke.Thickness = 2
    mainStroke.Transparency = 0.4
    
    local header = Instance.new("Frame")
    header.Size = UDim2.new(1, 0, 0, 50)
    header.BackgroundColor3 = Arqel.Theme.Header
    header.BorderSizePixel = 0
    header.Active = true
    header.Parent = main
    
    Instance.new("UICorner", header).CornerRadius = UDim.new(0, 4)
    
    local headerFix = Instance.new("Frame")
    headerFix.Size = UDim2.new(1, 0, 0, 8)
    headerFix.Position = UDim2.new(0, 0, 1, -8)
    headerFix.BackgroundColor3 = Arqel.Theme.Header
    headerFix.BorderSizePixel = 0
    headerFix.Parent = header
    
    local headerLine = Instance.new("Frame")
    headerLine.Size = UDim2.new(1, 0, 0, 1)
    headerLine.Position = UDim2.new(0, 0, 1, 0)
    headerLine.BackgroundColor3 = Arqel.Theme.Accent
    headerLine.BackgroundTransparency = 0.6
    headerLine.BorderSizePixel = 0
    headerLine.Parent = header
    
    local logo = Instance.new("ImageLabel")
    logo.Size = UDim2.new(0, 30, 0, 30)
    logo.Position = UDim2.new(0, padding, 0.5, 0)
    logo.AnchorPoint = Vector2.new(0, 0.5)
    logo.BackgroundTransparency = 1
    logo.Image = Arqel.Appearance.Icon
    logo.ImageColor3 = Arqel.Theme.Text
    logo.ScaleType = Enum.ScaleType.Fit
    logo.Parent = header
    
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, -90, 1, 0)
    title.Position = UDim2.new(0, padding + 40, 0, 0)
    title.BackgroundTransparency = 1
    title.Text = Arqel.Appearance.Title
    title.TextColor3 = Arqel.Theme.Text
    title.TextSize = mobile and 24 or 26
    title.Font = Enum.Font.GothamBold
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Parent = header
    
    local closeBtn = Instance.new("ImageButton")
    closeBtn.Size = UDim2.new(0, 18, 0, 18)
    closeBtn.Position = UDim2.new(1, -padding, 0.5, 0)
    closeBtn.AnchorPoint = Vector2.new(1, 0.5)
    closeBtn.BackgroundTransparency = 1
    closeBtn.Image = Icons.close
    closeBtn.ImageColor3 = Arqel.Theme.TextDim
    closeBtn.ScaleType = Enum.ScaleType.Fit
    closeBtn.Parent = header
    
    closeBtn.MouseEnter:Connect(function()
        TweenService:Create(closeBtn, TweenInfo.new(0.15), {ImageColor3 = Arqel.Theme.Error}):Play()
    end)
    closeBtn.MouseLeave:Connect(function()
        TweenService:Create(closeBtn, TweenInfo.new(0.15), {ImageColor3 = Arqel.Theme.TextDim}):Play()
    end)
    
    local contentY = 60
    
    local successBox = Instance.new("Frame")
    successBox.Size = UDim2.new(0.94, 0, 0, 52)
    successBox.Position = UDim2.new(0.5, 0, 0, contentY)
    successBox.AnchorPoint = Vector2.new(0.5, 0)
    successBox.BackgroundColor3 = Arqel.Theme.Success
    successBox.BackgroundTransparency = 0.85
    successBox.BorderSizePixel = 0
    successBox.Parent = main
    
    Instance.new("UICorner", successBox).CornerRadius = UDim.new(0, 4)
    
    local successStroke = Instance.new("UIStroke", successBox)
    successStroke.Color = Arqel.Theme.Success
    successStroke.Thickness = 1
    successStroke.Transparency = 0.5
    
    local checkIcon = Instance.new("ImageLabel")
    checkIcon.Size = UDim2.new(0, 24, 0, 24)
    checkIcon.Position = UDim2.new(0, 16, 0.5, 0)
    checkIcon.AnchorPoint = Vector2.new(0, 0.5)
    checkIcon.BackgroundTransparency = 1
    checkIcon.Image = Icons.check
    checkIcon.ImageColor3 = Arqel.Theme.Success
    checkIcon.ScaleType = Enum.ScaleType.Fit
    checkIcon.Parent = successBox
    
    local successText = Instance.new("TextLabel")
    successText.Size = UDim2.new(1, -60, 1, 0)
    successText.Position = UDim2.new(0, 52, 0, 0)
    successText.BackgroundTransparency = 1
    successText.Text = "Access Granted"
    successText.TextColor3 = Arqel.Theme.Success
    successText.TextSize = mobile and 17 or 18
    successText.Font = Enum.Font.GothamBold
    successText.TextXAlignment = Enum.TextXAlignment.Left
    successText.Parent = successBox
    
    local keylessText = Instance.new("TextLabel")
    keylessText.Size = UDim2.new(1, 0, 0, 20)
    keylessText.Position = UDim2.new(0.5, 0, 0, contentY + 60)
    keylessText.AnchorPoint = Vector2.new(0.5, 0)
    keylessText.BackgroundTransparency = 1
    keylessText.Text = "Keyless mode active"
    keylessText.TextColor3 = Arqel.Theme.TextDim
    keylessText.TextSize = mobile and 14 or 15
    keylessText.Font = Enum.Font.GothamBold
    keylessText.Parent = main
    
    local divider = Instance.new("Frame")
    divider.Size = UDim2.new(1, 0, 0, 3)
    divider.Position = UDim2.new(0, 0, 0, contentY + 88)
    divider.BackgroundColor3 = Arqel.Theme.Divider
    divider.BorderSizePixel = 0
    divider.Parent = main
    
    local launchBtn = Instance.new("TextButton")
    launchBtn.Size = UDim2.new(0.75, 0, 0, 42)
    launchBtn.Position = UDim2.new(0.5, 0, 0, contentY + 103)
    launchBtn.AnchorPoint = Vector2.new(0.5, 0)
    launchBtn.BackgroundColor3 = Arqel.Theme.Accent
    launchBtn.BorderSizePixel = 0
    launchBtn.Text = ""
    launchBtn.AutoButtonColor = false
    launchBtn.Parent = main
    
    Instance.new("UICorner", launchBtn).CornerRadius = UDim.new(0, 4)
    
    local launchStroke = Instance.new("UIStroke", launchBtn)
    launchStroke.Color = Arqel.Theme.AccentHover
    launchStroke.Thickness = 1
    launchStroke.Transparency = 0.5
    
    local launchContent = Instance.new("Frame")
    launchContent.Size = UDim2.new(1, 0, 1, 0)
    launchContent.BackgroundTransparency = 1
    launchContent.Parent = launchBtn
    
    local launchLayout = Instance.new("UIListLayout", launchContent)
    launchLayout.FillDirection = Enum.FillDirection.Horizontal
    launchLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    launchLayout.VerticalAlignment = Enum.VerticalAlignment.Center
    launchLayout.Padding = UDim.new(0, 8)
    
    local launchIcon = Instance.new("ImageLabel")
    launchIcon.Size = UDim2.new(0, 18, 0, 18)
    launchIcon.BackgroundTransparency = 1
    launchIcon.Image = Icons.shield
    launchIcon.ImageColor3 = Arqel.Theme.Text
    launchIcon.ScaleType = Enum.ScaleType.Fit
    launchIcon.LayoutOrder = 1
    launchIcon.Parent = launchContent
    
    local launchLabel = Instance.new("TextLabel")
    launchLabel.Size = UDim2.new(0, 0, 0, 18)
    launchLabel.AutomaticSize = Enum.AutomaticSize.X
    launchLabel.BackgroundTransparency = 1
    launchLabel.Text = "Launch Script"
    launchLabel.TextColor3 = Arqel.Theme.Text
    launchLabel.TextSize = mobile and 14 or 15
    launchLabel.Font = Enum.Font.GothamBold
    launchLabel.LayoutOrder = 2
    launchLabel.Parent = launchContent
    
    launchBtn.MouseEnter:Connect(function()
        TweenService:Create(launchBtn, TweenInfo.new(0.15), {BackgroundColor3 = Arqel.Theme.AccentHover}):Play()
    end)
    launchBtn.MouseLeave:Connect(function()
        TweenService:Create(launchBtn, TweenInfo.new(0.15), {BackgroundColor3 = Arqel.Theme.Accent}):Play()
    end)
    
    local discordBtn = Instance.new("TextButton")
    discordBtn.Size = UDim2.new(0, 36, 0, 36)
    discordBtn.Position = UDim2.new(0.5, 0, 0, contentY + 153)
    discordBtn.AnchorPoint = Vector2.new(0.5, 0)
    discordBtn.BackgroundColor3 = Arqel.Theme.Background
    discordBtn.BorderSizePixel = 0
    discordBtn.Text = ""
    discordBtn.AutoButtonColor = false
    discordBtn.Parent = main
    
    Instance.new("UICorner", discordBtn).CornerRadius = UDim.new(0, 4)
    
    local discordIcon = Instance.new("ImageLabel")
    discordIcon.Size = UDim2.new(0, 18, 0, 18)
    discordIcon.Position = UDim2.new(0.5, 0, 0.5, 0)
    discordIcon.AnchorPoint = Vector2.new(0.5, 0.5)
    discordIcon.BackgroundTransparency = 1
    discordIcon.Image = Icons.discord
    discordIcon.ImageColor3 = Arqel.Theme.Discord
    discordIcon.ScaleType = Enum.ScaleType.Fit
    discordIcon.Parent = discordBtn
    
    discordBtn.MouseEnter:Connect(function()
        TweenService:Create(discordIcon, TweenInfo.new(0.15), {ImageColor3 = Arqel.Theme.DiscordHover}):Play()
    end)
    discordBtn.MouseLeave:Connect(function()
        TweenService:Create(discordIcon, TweenInfo.new(0.15), {ImageColor3 = Arqel.Theme.Discord}):Play()
    end)
    
    local function closeUI()
        disableBlur()
        TweenService:Create(main, TweenInfo.new(0.4, Enum.EasingStyle.Quart), {
            Position = UDim2.new(0.5, 0, -0.5, 0),
            BackgroundTransparency = 1
        }):Play()
        TweenService:Create(mainStroke, TweenInfo.new(0.3), {Transparency = 1}):Play()
        task.wait(0.4)
        gui:Destroy()
    end
    
    closeBtn.MouseButton1Click:Connect(function()
        Arqel:Notify("Goodbye", "See you next time!", 2, "close")
        closeUI()
        if Arqel.Callbacks.OnClose then Arqel.Callbacks.OnClose() end
    end)
    
    launchBtn.MouseButton1Click:Connect(function()
        Arqel:Notify("Launching", "Script loaded successfully!", 2, "success")
        getgenv().SCRIPT_KEY = "KEYLESS"
        closeUI()
        if not Internal.IsJunkieMode and Arqel.Callbacks.OnSuccess then
            Arqel.Callbacks.OnSuccess()
        end
    end)
    
    discordBtn.MouseButton1Click:Connect(function()
        if Arqel.Links.Discord ~= "" then
            Arqel:Notify("Discord", "Invite link copied!", 2, "discord")
            pcall(function() setclipboard(Arqel.Links.Discord) end)
        end
    end)
    
    setupDragging(header, main)
    
    TweenService:Create(main, TweenInfo.new(0.5, Enum.EasingStyle.Quart), {
        Position = UDim2.new(0.5, 0, 0.5, 0)
    }):Play()
    
    checkIcon.Size = UDim2.new(0, 0, 0, 0)
    task.delay(0.3, function()
        TweenService:Create(checkIcon, TweenInfo.new(0.4, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
            Size = UDim2.new(0, 24, 0, 24)
        }):Play()
    end)
end

local function BuildKeyUI()
    local oldGui = CoreGui:FindFirstChild("ArqelKeySystem")
    if oldGui then oldGui:Destroy() end
    
    enableBlur()
    
    local mobile = isMobile()
    local scale = getScale()
    local padding = 14
    
    local windowWidth = mobile and math.clamp(400 * scale, 320, 440) or 400
    local windowHeight = mobile and math.clamp(360 * scale, 320, 400) or 360
    local elementHeight = mobile and math.clamp(56 * scale, 48, 62) or 56
    local buttonHeight = mobile and math.clamp(42 * scale, 38, 48) or 42
    local statusHeight = mobile and math.clamp(60 * scale, 52, 68) or 60
    
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "ArqelKeySystem"
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    screenGui.ResetOnSpawn = false
    screenGui.IgnoreGuiInset = true
    screenGui.Parent = CoreGui
    
    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0, windowWidth, 0, windowHeight)
    mainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
    mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    mainFrame.BackgroundColor3 = Arqel.Theme.Background
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui
    
    Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 4)
    
    local mainStroke = Instance.new("UIStroke", mainFrame)
    mainStroke.Color = Arqel.Theme.Accent
    mainStroke.Thickness = 2
    mainStroke.Transparency = 0.4
    
    local header = Instance.new("Frame")
    header.Size = UDim2.new(1, 0, 0, 50)
    header.BackgroundColor3 = Arqel.Theme.Header
    header.BorderSizePixel = 0
    header.Active = true
    header.Parent = mainFrame
    
    Instance.new("UICorner", header).CornerRadius = UDim.new(0, 4)
    
    local headerFix = Instance.new("Frame")
    headerFix.Size = UDim2.new(1, 0, 0, 6)
    headerFix.Position = UDim2.new(0, 0, 1, -6)
    headerFix.BackgroundColor3 = Arqel.Theme.Header
    headerFix.BorderSizePixel = 0
    headerFix.Parent = header
    
    local headerLine = Instance.new("Frame")
    headerLine.Size = UDim2.new(1, 0, 0, 1)
    headerLine.Position = UDim2.new(0, 0, 1, 0)
    headerLine.BackgroundColor3 = Arqel.Theme.Accent
    headerLine.BackgroundTransparency = 0.6
    headerLine.BorderSizePixel = 0
    headerLine.Parent = header
    
    local logo = Instance.new("ImageLabel")
    logo.Size = Arqel.Appearance.IconSize
    logo.Position = UDim2.new(0, padding, 0.5, 0)
    logo.AnchorPoint = Vector2.new(0, 0.5)
    logo.BackgroundTransparency = 1
    logo.Image = Arqel.Appearance.Icon
    logo.ImageColor3 = Arqel.Theme.Text
    logo.ScaleType = Enum.ScaleType.Fit
    logo.Parent = header
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, -90, 1, 0)
    titleLabel.Position = UDim2.new(0, padding + Arqel.Appearance.IconSize.X.Offset + 10, 0, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = Arqel.Appearance.Title
    titleLabel.TextColor3 = Arqel.Theme.Text
    titleLabel.TextSize = mobile and 24 or 26
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.Parent = header
    
    local closeBtn = Instance.new("ImageButton")
    closeBtn.Size = UDim2.new(0, 18, 0, 18)
    closeBtn.Position = UDim2.new(1, -padding, 0.5, 0)
    closeBtn.AnchorPoint = Vector2.new(1, 0.5)
    closeBtn.BackgroundTransparency = 1
    closeBtn.Image = Icons.close
    closeBtn.ImageColor3 = Arqel.Theme.TextDim
    closeBtn.ScaleType = Enum.ScaleType.Fit
    closeBtn.Parent = header
    
    closeBtn.MouseEnter:Connect(function()
        TweenService:Create(closeBtn, TweenInfo.new(0.15), {ImageColor3 = Arqel.Theme.Error}):Play()
    end)
    closeBtn.MouseLeave:Connect(function()
        TweenService:Create(closeBtn, TweenInfo.new(0.15), {ImageColor3 = Arqel.Theme.TextDim}):Play()
    end)
    
    local function handleClose()
        Arqel:Notify("Goodbye", "See you next time!", 2, "close")
        disableBlur()
        TweenService:Create(mainFrame, TweenInfo.new(0.4, Enum.EasingStyle.Quart), {
            Position = UDim2.new(0.5, 0, -0.5, 0),
            BackgroundTransparency = 1
        }):Play()
        task.wait(0.4)
        screenGui:Destroy()
        if Arqel.Callbacks.OnClose then Arqel.Callbacks.OnClose() end
    end
    
    closeBtn.MouseButton1Click:Connect(handleClose)
    
    local contentStartY = 60
    
    local statusFrame = Instance.new("Frame")
    statusFrame.Size = UDim2.new(0.94, 0, 0, statusHeight)
    statusFrame.Position = UDim2.new(0.5, 0, 0, contentStartY)
    statusFrame.AnchorPoint = Vector2.new(0.5, 0)
    statusFrame.BackgroundColor3 = Arqel.Theme.Input
    statusFrame.BorderSizePixel = 0
    statusFrame.ClipsDescendants = true
    statusFrame.Parent = mainFrame
    
    Instance.new("UICorner", statusFrame).CornerRadius = UDim.new(0, 4)
    
    local statusStroke = Instance.new("UIStroke", statusFrame)
    statusStroke.Color = Arqel.Theme.Accent
    statusStroke.Thickness = 1
    statusStroke.Transparency = 0.8
    
    local statusIcon = Instance.new("ImageLabel")
    statusIcon.Size = UDim2.new(0, 24, 0, 24)
    statusIcon.Position = UDim2.new(0, 16, 0.5, 0)
    statusIcon.AnchorPoint = Vector2.new(0, 0.5)
    statusIcon.BackgroundTransparency = 1
    statusIcon.Image = Icons.lock
    statusIcon.ImageColor3 = Arqel.Theme.StatusIdle
    statusIcon.ScaleType = Enum.ScaleType.Fit
    statusIcon.Parent = statusFrame
    
    local statusLabel = Instance.new("TextLabel")
    statusLabel.Size = UDim2.new(1, -60, 1, 0)
    statusLabel.Position = UDim2.new(0, 52, 0, 0)
    statusLabel.BackgroundTransparency = 1
    statusLabel.Text = Arqel.Appearance.Subtitle
    statusLabel.TextColor3 = Arqel.Theme.StatusIdle
    statusLabel.TextSize = mobile and 17 or 18
    statusLabel.Font = Enum.Font.GothamMedium
    statusLabel.TextXAlignment = Enum.TextXAlignment.Left
    statusLabel.TextTruncate = Enum.TextTruncate.AtEnd
    statusLabel.Parent = statusFrame
    
    local inputStartY = contentStartY + statusHeight + 10
    
    local inputFrame = Instance.new("Frame")
    inputFrame.Size = UDim2.new(0.94, 0, 0, elementHeight)
    inputFrame.Position = UDim2.new(0.5, 0, 0, inputStartY)
    inputFrame.AnchorPoint = Vector2.new(0.5, 0)
    inputFrame.BackgroundColor3 = Arqel.Theme.Input
    inputFrame.BorderSizePixel = 0
    inputFrame.ClipsDescendants = true
    inputFrame.Parent = mainFrame
    
    Instance.new("UICorner", inputFrame).CornerRadius = UDim.new(0, 4)
    
    local inputStroke = Instance.new("UIStroke", inputFrame)
    inputStroke.Color = Arqel.Theme.Accent
    inputStroke.Thickness = 1
    inputStroke.Transparency = 0.7
    
    local textBox = Instance.new("TextBox")
    textBox.Size = UDim2.new(1, -24, 1, 0)
    textBox.Position = UDim2.new(0, 12, 0.5, 0)
    textBox.AnchorPoint = Vector2.new(0, 0.5)
    textBox.BackgroundTransparency = 1
    textBox.Text = ""
    textBox.TextColor3 = Arqel.Theme.Text
    textBox.PlaceholderText = "Enter your license key..."
    textBox.PlaceholderColor3 = Arqel.Theme.TextDim
    textBox.TextSize = mobile and 17 or 18
    textBox.Font = Enum.Font.GothamMedium
    textBox.ClearTextOnFocus = false
    textBox.TextTruncate = Enum.TextTruncate.AtEnd
    textBox.TextXAlignment = Enum.TextXAlignment.Left
    textBox.Parent = inputFrame
    
    textBox.Focused:Connect(function()
        TweenService:Create(inputStroke, TweenInfo.new(0.15), {Transparency = 0.3}):Play()
    end)
    textBox.FocusLost:Connect(function()
        TweenService:Create(inputStroke, TweenInfo.new(0.15), {Transparency = 0.7}):Play()
    end)
    
    local dividerY = inputStartY + elementHeight + 12
    
    local dividerLine = Instance.new("Frame")
    dividerLine.Size = UDim2.new(1, 0, 0, 3)
    dividerLine.Position = UDim2.new(0, 0, 0, dividerY)
    dividerLine.BackgroundColor3 = Arqel.Theme.Divider
    dividerLine.BorderSizePixel = 0
    dividerLine.Parent = mainFrame
    
    local acquireStartY = dividerY + 15
    
    local function createButton(text, iconKey, isPrimary, yPos)
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(0.75, 0, 0, buttonHeight)
        btn.Position = UDim2.new(0.5, 0, 0, yPos)
        btn.AnchorPoint = Vector2.new(0.5, 0)
        btn.BackgroundColor3 = isPrimary and Arqel.Theme.Accent or Arqel.Theme.Input
        btn.BorderSizePixel = 0
        btn.Text = ""
        btn.AutoButtonColor = false
        btn.Parent = mainFrame
        
        Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 4)
        
        local btnStroke = Instance.new("UIStroke", btn)
        btnStroke.Color = isPrimary and Arqel.Theme.AccentHover or Arqel.Theme.Accent
        btnStroke.Thickness = 1
        btnStroke.Transparency = isPrimary and 0.5 or 0.7
        
        local content = Instance.new("Frame")
        content.Size = UDim2.new(1, 0, 1, 0)
        content.BackgroundTransparency = 1
        content.Parent = btn
        
        local layout = Instance.new("UIListLayout", content)
        layout.FillDirection = Enum.FillDirection.Horizontal
        layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
        layout.VerticalAlignment = Enum.VerticalAlignment.Center
        layout.Padding = UDim.new(0, 8)
        
        local iconImg = Instance.new("ImageLabel")
        iconImg.Size = UDim2.new(0, 18, 0, 18)
        iconImg.BackgroundTransparency = 1
        iconImg.Image = Icons[iconKey] or Icons.key
        iconImg.ImageColor3 = Arqel.Theme.Text
        iconImg.ScaleType = Enum.ScaleType.Fit
        iconImg.LayoutOrder = 1
        iconImg.Parent = content
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(0, 0, 0, 20)
        label.AutomaticSize = Enum.AutomaticSize.X
        label.BackgroundTransparency = 1
        label.Text = text
        label.TextColor3 = Arqel.Theme.Text
        label.TextSize = mobile and 14 or 15
        label.Font = Enum.Font.GothamBold
        label.LayoutOrder = 2
        label.Parent = content
        
        local origColor = btn.BackgroundColor3
        local hoverColor = isPrimary and Arqel.Theme.AccentHover or Arqel.Theme.Accent
        
        btn.MouseEnter:Connect(function()
            TweenService:Create(btn, TweenInfo.new(0.15), {BackgroundColor3 = hoverColor}):Play()
        end)
        btn.MouseLeave:Connect(function()
            TweenService:Create(btn, TweenInfo.new(0.15), {BackgroundColor3 = origColor}):Play()
        end)
        
        return btn
    end
    
    local acquireBtn = createButton("Acquire License", "key", false, acquireStartY)
    local redeemBtn = createButton("Redeem License", "shield", true, acquireStartY + buttonHeight + 5)
    
    local discordBtn = Instance.new("TextButton")
    discordBtn.Size = UDim2.new(0, 36, 0, 36)
    discordBtn.Position = UDim2.new(0.5, 0, 0, acquireStartY + buttonHeight * 2 + 10)
    discordBtn.AnchorPoint = Vector2.new(0.5, 0)
    discordBtn.BackgroundColor3 = Arqel.Theme.Background
    discordBtn.BorderSizePixel = 0
    discordBtn.Text = ""
    discordBtn.AutoButtonColor = false
    discordBtn.Parent = mainFrame
    
    Instance.new("UICorner", discordBtn).CornerRadius = UDim.new(0, 4)
    
    local discordIcon = Instance.new("ImageLabel")
    discordIcon.Size = UDim2.new(0, 18, 0, 18)
    discordIcon.Position = UDim2.new(0.5, 0, 0.5, 0)
    discordIcon.AnchorPoint = Vector2.new(0.5, 0.5)
    discordIcon.BackgroundTransparency = 1
    discordIcon.Image = Icons.discord
    discordIcon.ImageColor3 = Arqel.Theme.Discord
    discordIcon.ScaleType = Enum.ScaleType.Fit
    discordIcon.Parent = discordBtn
    
    discordBtn.MouseEnter:Connect(function()
        TweenService:Create(discordIcon, TweenInfo.new(0.15), {ImageColor3 = Arqel.Theme.DiscordHover}):Play()
    end)
    discordBtn.MouseLeave:Connect(function()
        TweenService:Create(discordIcon, TweenInfo.new(0.15), {ImageColor3 = Arqel.Theme.Discord}):Play()
    end)
    
    local spinConnection, dotsThread
    
    local function setStatus(state, customText)
        if spinConnection then spinConnection:Disconnect(); spinConnection = nil; statusIcon.Rotation = 0 end
        if dotsThread then task.cancel(dotsThread); dotsThread = nil end
        
        local color, icon, text = Arqel.Theme.StatusIdle, Icons.lock, customText or "No key detected"
        
        if state == "verifying" then
            color, icon, text = Arqel.Theme.Accent, Icons.loading, "Verifying license"
            spinConnection = RunService.Heartbeat:Connect(function(dt)
                if statusIcon and statusIcon.Parent then
                    statusIcon.Rotation = (statusIcon.Rotation + dt * 360) % 360
                else
                    if spinConnection then spinConnection:Disconnect() end
                end
            end)
            local dots, i = {".", "..", "...", ""}, 1
            dotsThread = task.spawn(function()
                while statusLabel and statusLabel.Parent and statusLabel.Text:find("Verifying", 1, true) do
                    statusLabel.Text = text .. dots[i]
                    i = (i % #dots) + 1
                    task.wait(0.4)
                end
            end)
        elseif state == "success" then
            color, icon, text = Arqel.Theme.Success, Icons.check, customText or "Access Granted"
        elseif state == "error" then
            color, icon, text = Arqel.Theme.Error, Icons.alert, customText or "Invalid License"
        end
        
        TweenService:Create(statusLabel, TweenInfo.new(0.3), {TextColor3 = color}):Play()
        TweenService:Create(statusIcon, TweenInfo.new(0.3), {ImageColor3 = color}):Play()
        statusLabel.Text = text
        statusIcon.Image = icon
    end
    
    local function handleRedeem()
        local key = textBox.Text:gsub("%s+", "")
        if key == "" then
            Arqel:Notify("Error", "Please enter your license key", 3, "warning")
            return
        end
        
        setStatus("verifying")
        redeemBtn.Active = false
        task.wait(0.3)
        
        local valid, errorMsg = false, "Invalid key"
        
        if Internal.ValidateFunction then
            local success, result, msg = pcall(Internal.ValidateFunction, key)
            if success then
                if type(result) == "table" then
                    valid = result.valid == true
                    local errMsgs = {
                        KEY_INVALID = "Key not found in system",
                        KEY_EXPIRED = "License has expired",
                        HWID_BANNED = "Hardware banned",
                        KEY_INVALIDATED = "License was revoked",
                        ALREADY_USED = "One-time key already used",
                        HWID_MISMATCH = "HWID limit reached",
                        SERVICE_NOT_FOUND = "Service not found",
                        SERVICE_MISMATCH = "Wrong service",
                        PREMIUM_REQUIRED = "Premium required",
                        ERROR = "Network error"
                    }
                    local errCode = result.error or "Unknown"
                    errorMsg = errMsgs[errCode] or result.message or errCode
                    if errCode == "HWID_BANNED" then
                        task.delay(2, function() game.Players.LocalPlayer:Kick("Hardware banned") end)
                    end
                elseif type(result) == "boolean" then
                    valid = result
                    errorMsg = msg or "Invalid key"
                end
            end
        end
        
        redeemBtn.Active = true
        
        if valid then
            saveKey(key)
            getgenv().SCRIPT_KEY = key
            setStatus("success")
            Arqel:Notify("Success", "License validated successfully!", 2, "success")
            task.wait(1)
            disableBlur()
            TweenService:Create(mainFrame, TweenInfo.new(0.4, Enum.EasingStyle.Quart), {
                Position = UDim2.new(0.5, 0, -0.5, 0), BackgroundTransparency = 1
            }):Play()
            task.wait(0.4)
            screenGui:Destroy()
            if not Internal.IsJunkieMode and Arqel.Callbacks.OnSuccess then Arqel.Callbacks.OnSuccess() end
        else
            setStatus("error", errorMsg)
            Arqel:Notify("Invalid", errorMsg, 4, "error")
            if Arqel.Callbacks.OnFail then Arqel.Callbacks.OnFail(errorMsg) end
        end
    end
    
    redeemBtn.MouseButton1Click:Connect(handleRedeem)
    
    acquireBtn.MouseButton1Click:Connect(function()
        if Arqel.Links.GetKey ~= "" then
            Arqel:Notify("Copied", "License link copied!", 3, "copy")
            pcall(function() setclipboard(Arqel.Links.GetKey) end)
        else
            Arqel:Notify("Error", "No key link set", 3, "warning")
        end
    end)
    
    discordBtn.MouseButton1Click:Connect(function()
        if Arqel.Links.Discord ~= "" then
            Arqel:Notify("Discord", "Invite link copied!", 2, "discord")
            pcall(function() setclipboard(Arqel.Links.Discord) end)
        end
    end)
    
    textBox.FocusLost:Connect(function(enter) if enter then handleRedeem() end end)
    
    setupDragging(header, mainFrame)
    
    mainFrame.Position = UDim2.new(0.5, 0, 1.5, 0)
    TweenService:Create(mainFrame, TweenInfo.new(0.5, Enum.EasingStyle.Quart), {
        Position = UDim2.new(0.5, 0, 0.5, 0)
    }):Play()
end

function Arqel:Launch()
    Internal.IsJunkieMode = false
    Internal.ValidateFunction = Arqel.Callbacks.OnVerify
    
    if Arqel.Options.Keyless == true then
        BuildKeylessUI()
        while not getgenv().SCRIPT_KEY do task.wait(0.1) end
        return
    end
    
    if Arqel.Storage.AutoLoad and Internal.ValidateFunction then
        local savedKey = loadKey()
        if savedKey and savedKey ~= "" then
            Arqel:Notify("Checking", "Validating saved license...", 2, "shield")
            task.wait(0.5)
            local success, result = pcall(Internal.ValidateFunction, savedKey)
            local valid = success and ((type(result) == "table" and result.valid) or (type(result) == "boolean" and result))
            if valid then
                getgenv().SCRIPT_KEY = savedKey
                Arqel:Notify("Welcome Back", "License validated!", 2, "success")
                if Arqel.Callbacks.OnSuccess then Arqel.Callbacks.OnSuccess() end
                return
            else
                clearKey()
                Arqel:Notify("Expired", "Saved license is no longer valid", 3, "warning")
                task.wait(1)
            end
        end
    end
    
    BuildKeyUI()
    while not getgenv().SCRIPT_KEY do task.wait(0.1) end
end

function Arqel:LaunchJunkie(config)
    assert(config and config.Service and config.Identifier and config.Provider, "Junkie config required: Service, Identifier, Provider")
    
    Internal.IsJunkieMode = true
    
    local success, Junkie = pcall(function()
        return loadstring(game:HttpGet("https://jnkie.com/sdk/library.lua"))()
    end)
    
    if not success or not Junkie then
        Arqel:Notify("Error", "Failed to load Junkie SDK", 5, "error")
        return
    end
    
    Junkie.service = config.Service
    Junkie.identifier = config.Identifier
    Junkie.provider = config.Provider
    Internal.Junkie = Junkie
    
    if Arqel.Links.GetKey == "" then
        pcall(function() Arqel.Links.GetKey = Junkie.get_key_link() end)
    end
    
    Internal.ValidateFunction = function(key) return Junkie.check_key(key) end
    
    if Arqel.Options.Keyless == nil then
        local ks, kr = pcall(function() return Junkie.check_key("KEYLESS") end)
        if ks and kr and kr.valid then
            BuildKeylessUI()
            while not getgenv().SCRIPT_KEY do task.wait(0.1) end
            return
        end
    elseif Arqel.Options.Keyless == true then
        BuildKeylessUI()
        while not getgenv().SCRIPT_KEY do task.wait(0.1) end
        return
    end
    
    if Arqel.Storage.AutoLoad then
        local savedKey = loadKey()
        if savedKey and savedKey ~= "" then
            Arqel:Notify("Checking", "Validating saved license...", 2, "shield")
            task.wait(0.5)
            local vs, vr = pcall(function() return Junkie.check_key(savedKey) end)
            if vs and vr and vr.valid then
                getgenv().SCRIPT_KEY = savedKey
                Arqel:Notify("Welcome Back", "License validated!", 2, "success")
                return
            else
                clearKey()
                Arqel:Notify("Expired", "Saved license is no longer valid", 3, "warning")
                task.wait(1)
            end
        end
    end
    
    BuildKeyUI()
    while not getgenv().SCRIPT_KEY do task.wait(0.1) end
end

function Arqel:GetSavedKey() return loadKey() end
function Arqel:ClearSavedKey() return clearKey() end

return Arqel
